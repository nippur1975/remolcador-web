<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitor Remolcadores - Por HDelacruz</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <style>
        :root {
            --tz-bg: #14191e;
            --tz-accent: #00e5ff;
            --tz-border: #34495e;
            --tz-text: #ecf0f1;
        }

        body, html { margin: 0; padding: 0; height: 100%; background: #0b0e11; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; background: #001529; }

        /* Sidebar Estilo Nobeltec */
        .tz-sidebar {
            position: absolute; left: 15px; top: 15px; z-index: 1000;
            display: flex; flex-direction: column; gap: 8px;
        }

        .tz-btn {
            width: 44px; height: 44px; background: var(--tz-bg);
            border: 1px solid var(--tz-border); border-radius: 4px;
            color: white; cursor: pointer; display: flex; align-items: center;
            justify-content: center; font-weight: bold; font-size: 13px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.4); transition: 0.2s;
        }

        .tz-btn:hover { border-color: var(--tz-accent); background: #1c252e; }
        .tz-btn.active { color: var(--tz-accent); border-color: var(--tz-accent); box-shadow: 0 0 8px var(--tz-accent); }

        /* Panel de Control */
        .selector-panel {
            position: absolute; top: 15px; right: 15px; z-index: 1000;
            background: rgba(20, 25, 30, 0.95); padding: 15px; border-radius: 4px; 
            width: 260px; border-top: 3px solid var(--tz-accent); color: var(--tz-text);
            backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .ship-label {
            background: none !important; border: none !important;
            color: #ffffff; font-weight: bold; font-size: 10px;
            text-shadow: 1px 1px 2px #000; text-transform: uppercase;
        }

        select {
            width: 100%; background: #000; color: var(--tz-accent);
            border: 1px solid var(--tz-border); padding: 8px;
            margin: 10px 0; border-radius: 3px; font-weight: bold; cursor: pointer;
        }

        .vessel-info-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 5px; }
        .vessel-info-table td { padding: 3px 0; border-bottom: 1px solid #2c3e50; }

        .leaflet-control-zoom, .leaflet-control-layers, .polyline-measure-unicode-icon { display: none !important; }
    </style>
</head>
<body>

    <div class="tz-sidebar">
        <button class="tz-btn active" id="btn-dark" onclick="changeLayer('dark')">DRK</button>
        <button class="tz-btn" id="btn-osm" onclick="changeLayer('osm')">STD</button>
        <button class="tz-btn" id="btn-sat" onclick="changeLayer('sat')">SAT</button>
        <div style="height: 10px; border-bottom: 1px solid var(--tz-border); margin-bottom: 5px;"></div>
        <button class="tz-btn" onclick="map.zoomIn()">+</button>
        <button class="tz-btn" onclick="map.zoomOut()">-</button>
        <button class="tz-btn" id="btn-ruler" onclick="toggleRuler()">üìè</button>
    </div>

    <div class="selector-panel">
        <div style="font-weight: bold; font-size: 12px; color: var(--tz-accent);">MONITOR REMOLCADORES&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SELECCIONAR REMOLCADOR</div>
        <select id="shipSelector">
            <option value="all">-- VISTA GENERAL --</option>
        </select>
        <div id="stats" style="font-size:10px; opacity: 0.8;">Sincronizando...</div>
    </div>

    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>

    <script>
        const SUPABASE_URL = 'https://lnxziegzyilfnibmfrtz.supabase.co'; 
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxueHppZWd6eWlsZm5pYm1mcnR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMjI1OTQsImV4cCI6MjA4NDU5ODU5NH0.ltom27lQCmTyI-3NfPW6tMWpEMOL6fXh2dc8ksx0DsQ';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const layerDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        const layerOSM = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
        const layerSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

        const map = L.map('map', { zoomControl: false, attributionControl: false, layers: [layerDark] }).setView([-12.05, -77.15], 13);
        const rulerControl = L.control.polylineMeasure({ position: 'topleft', unit: 'nauticalmiles' }).addTo(map);

        const markers = {};
        let currentFocus = "all";
        let isRulerActive = false;

        function changeLayer(type) {
            map.removeLayer(layerDark); map.removeLayer(layerOSM); map.removeLayer(layerSat);
            document.querySelectorAll('.tz-btn').forEach(b => b.classList.remove('active'));
            if(type === 'osm') { map.addLayer(layerOSM); document.getElementById('btn-osm').classList.add('active'); }
            else if(type === 'sat') { map.addLayer(layerSat); document.getElementById('btn-sat').classList.add('active'); }
            else { map.addLayer(layerDark); document.getElementById('btn-dark').classList.add('active'); }
        }

        function toggleRuler() {
            isRulerActive = !isRulerActive;
            document.querySelector('.polyline-measure-unicode-icon').click();
            document.getElementById('btn-ruler').classList.toggle('active', isRulerActive);
        }

        function createIcon(color, rotation) {
            return L.divIcon({
                className: 'ship-icon',
                html: `<div style="transform: rotate(${rotation}deg); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 16px solid ${color}; filter: drop-shadow(0 0 2px black);"></div>`,
                iconSize: [16, 16], iconAnchor: [8, 8]
            });
        }

        function updateMarker(data, type) {
            const id = data.mmsi || data.ship_id;
            if (!id) return;

            const lat = parseFloat(data.lat), lon = parseFloat(data.lon);
            if (isNaN(lat) || isNaN(lon)) return;

            const name = (data.ship_name || data.ship_id || id).toString().toUpperCase();
            const color = (type === 'propio') ? '#ff3b30' : '#007aff';
            const heading = parseFloat(data.heading || data.cog || 0);

            if (!markers[id]) {
                markers[id] = L.marker([lat, lon], { icon: createIcon(color, heading) });
                markers[id].vesselType = type;
                markers[id].bindTooltip(name, { permanent: true, direction: 'top', className: 'ship-label', offset: [0, -10] });
                
                if (type === 'propio') {
                    const sel = document.getElementById('shipSelector');
                    if (![...sel.options].some(o => o.value == id)) sel.add(new Option(name, id));
                }
            } else {
                markers[id].setLatLng([lat, lon]);
                markers[id].setIcon(createIcon(color, heading));
            }

            // --- L√ìGICA DE V√çNCULO CON SOURCE_ID ---
            // Guardamos qui√©n report√≥ este AIS usando la columna source_id
            if(type === 'ais') {
                markers[id].sentBy = data.source_id; 
            }

            markers[id].bindPopup(`
                <div style="background:#14191e; color:white; font-size:11px;">
                    <b>${name}</b><br>
                    SOG: ${data.sog || 0} kn | COG: ${heading}¬∞<br>
                    ${type === 'ais' ? `<small style="color:yellow">V√≠a: ${data.source_id}</small>` : ''}
                </div>`);

            applyVisibilityFilter(id);
            if (currentFocus === id) map.panTo([lat, lon]);
        }

        function applyVisibilityFilter(targetId) {
            const marker = markers[targetId];
            if (!marker) return;

            if (currentFocus === "all") {
                marker.addTo(map);
            } else {
                // El barco seleccionado es siempre visible
                const isSelectedShip = (targetId === currentFocus);
                // Si es AIS, solo se muestra si su source_id coincide con el barco seleccionado
                const isAisFromSelected = (marker.vesselType === 'ais' && marker.sentBy === currentFocus);
                // Otros barcos propios se mantienen visibles para contexto de flota
                const isOtherPropio = (marker.vesselType === 'propio');

                if (isSelectedShip || isAisFromSelected || isOtherPropio) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            }
        }

        async function sync() {
            const { data: nmea } = await supabaseClient.from('nmea_logs').select('*').order('date_event', {ascending: false}).limit(50);
            const { data: ais } = await supabaseClient.from('ais_live').select('*').order('last_seen', {ascending: false}).limit(200);
            
            if (nmea) nmea.forEach(x => updateMarker(x, 'propio'));
            if (ais) ais.forEach(x => updateMarker(x, 'ais'));
            
            document.getElementById('stats').innerText = `FLOTA: ${nmea?.length || 0} | AIS TOTALES: ${ais?.length || 0}`;
        }

        supabaseClient.channel('vts-realtime')
            .on('postgres_changes',{event:'*',schema:'public',table:'nmea_logs'}, p => updateMarker(p.new || p.old, 'propio'))
            .on('postgres_changes',{event:'*',schema:'public',table:'ais_live'}, p => updateMarker(p.new || p.old, 'ais'))
            .subscribe();

        document.getElementById('shipSelector').onchange = (e) => {
            currentFocus = e.target.value;
            // Al cambiar el barco, re-evaluamos la visibilidad de todos los marcadores
            Object.keys(markers).forEach(id => applyVisibilityFilter(id));
            
            if (currentFocus !== "all" && markers[currentFocus]) {
                map.flyTo(markers[currentFocus].getLatLng(), 14);
            }
        };

        sync();
    </script>
</body>
</html>
